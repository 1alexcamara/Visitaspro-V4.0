<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Visitas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
    }
    h1 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
      vertical-align: middle;
    }
    th {
      background-color: #f0f0f0;
    }
    .btn {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 15px;
    }
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .btn-small {
      width: auto;
      padding: 5px 10px;
      font-size: 12px;
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <h1>Registro de Visitas a Clientes</h1>

  <form id="visitForm">
    <label for="cliente">Cliente:</label>
    <input type="text" id="cliente" placeholder="Nombre del cliente" required />

    <label for="taller">Nombre del taller:</label>
    <input type="text" id="taller" placeholder="Nombre del taller" />

    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha" required />

    <label for="horaLlegada">Hora de llegada:</label>
    <input type="time" id="horaLlegada" required />

    <label for="comentarios">Comentarios del cliente:</label>
    <textarea id="comentarios" rows="3" placeholder="Comentarios..."></textarea>

    <label for="horaSalida">Hora de salida:</label>
    <input type="time" id="horaSalida" />

    <label for="fechaSeguimiento">Fecha de seguimiento:</label>
    <input type="date" id="fechaSeguimiento" />

    <button type="submit" class="btn">Guardar Visita</button>
  </form>

  <h2>Historial de visitas</h2>

  <!-- Filtros y botón de exportación -->
  <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
    <label for="fechaInicio">Desde:</label>
    <input type="date" id="fechaInicio" />

    <label for="fechaFin">Hasta:</label>
    <input type="date" id="fechaFin" />

    <button id="exportarExcel" class="btn" style="background:#007bff;">Exportar a Excel</button>
  </div>

  <table id="tablaVisitas">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Taller</th>
        <th>Fecha</th>
        <th>Hora llegada</th>
        <th>Comentarios</th>
        <th>Hora salida</th>
        <th>Seguimiento</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aquí van las visitas -->
    </tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const form = document.getElementById('visitForm');
    const tablaBody = document.querySelector('#tablaVisitas tbody');

    function setFechaHoraActual() {
      const ahora = new Date();
      const fechaStr = ahora.toISOString().slice(0,10);
      const horaStr = ahora.toTimeString().slice(0,5);
      document.getElementById('fecha').value = fechaStr;
      document.getElementById('horaLlegada').value = horaStr;
    }

    setFechaHoraActual();

    function guardarVisitas(visitas) {
      localStorage.setItem('visitas', JSON.stringify(visitas));
    }

    function obtenerVisitas() {
      const visitas = localStorage.getItem('visitas');
      return visitas ? JSON.parse(visitas) : [];
    }

    function crearLinkCalendario(titulo, descripcion, fecha) {
      if (!fecha) return '';

      const fechaEvento = new Date(fecha + 'T09:00:00');
      const fechaFin = new Date(fechaEvento.getTime() + 60*60*1000);

      const titleEnc = encodeURIComponent(titulo);
      const descEnc = encodeURIComponent(descripcion);
      const startISO = fechaEvento.toISOString().replace(/-|:|\.\d+/g, '');
      const endISO = fechaFin.toISOString().replace(/-|:|\.\d+/g, '');

      const icsContent = `
BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${titulo}
DESCRIPTION:${descripcion}
DTSTART:${startISO}
DTEND:${endISO}
BEGIN:VALARM
TRIGGER:-PT24H
DESCRIPTION:Recordatorio de seguimiento
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR
`.trim();

      const blob = new Blob([icsContent], {type: 'text/calendar'});
      const url = URL.createObjectURL(blob);
      return url;
    }

    function mostrarVisitas() {
      const visitas = obtenerVisitas();
      tablaBody.innerHTML = '';

      visitas.forEach((v, i) => {
        const tr = document.createElement('tr');

        let botonCalendario = '';
        if(v.fechaSeguimiento) {
          const tituloEvento = `Seguimiento: ${v.cliente}`;
          const descripcionEvento = `Taller: ${v.taller}\nComentarios: ${v.comentarios}`;
          const linkCal = crearLinkCalendario(tituloEvento, descripcionEvento, v.fechaSeguimiento);
          botonCalendario = `<a href="${linkCal}" download="seguimiento.ics" class="btn-small" style="background:#007bff;">Agregar seguimiento</a>`;
        }

        tr.innerHTML = `
          <td>${v.cliente}</td>
          <td>${v.taller || ''}</td>
          <td>${v.fecha}</td>
          <td>${v.horaLlegada}</td>
          <td>${v.comentarios}</td>
          <td>${v.horaSalida || ''}</td>
          <td>${v.fechaSeguimiento || ''} ${botonCalendario}</td>
          <td>
            <button class="btn-small" onclick="editarVisita(${i})">Editar</button>
            <button class="btn-small" onclick="eliminarVisita(${i})" style="background-color:#dc3545;">Eliminar</button>
          </td>
        `;

        tablaBody.appendChild(tr);
      });
    }

    mostrarVisitas();

    form.addEventListener('submit', function(e){
      e.preventDefault();

      const cliente = form.cliente.value.trim();
      const taller = form.taller.value.trim();
      const fecha = form.fecha.value;
      const horaLlegada = form.horaLlegada.value;
      const comentarios = form.comentarios.value.trim();
      const horaSalida = form.horaSalida.value;
      const fechaSeguimiento = form.fechaSeguimiento.value;

      if (!cliente || !fecha || !horaLlegada) {
        alert('Por favor, completa los campos obligatorios: Cliente, Fecha y Hora de llegada.');
        return;
      }

      let visitas = obtenerVisitas();

      visitas.push({
        cliente,
        taller,
        fecha,
        horaLlegada,
        comentarios,
        horaSalida,
        fechaSeguimiento
      });

      guardarVisitas(visitas);
      mostrarVisitas();
      form.reset();
      setFechaHoraActual();
    });

    function editarVisita(index) {
      const visitas = obtenerVisitas();
      const v = visitas[index];
      form.cliente.value = v.cliente;
      form.taller.value = v.taller;
      form.fecha.value = v.fecha;
      form.horaLlegada.value = v.horaLlegada;
      form.comentarios.value = v.comentarios;
      form.horaSalida.value = v.horaSalida;
      form.fechaSeguimiento.value = v.fechaSeguimiento;

      visitas.splice(index,1);
      guardarVisitas(visitas);
      mostrarVisitas();
    }

    function eliminarVisita(index) {
      if (confirm('¿Seguro quieres eliminar esta visita?')) {
        const visitas = obtenerVisitas();
        visitas.splice(index,1);
        guardarVisitas(visitas);
        mostrarVisitas();
      }
    }

    // --- EXPORTAR A EXCEL ---
    document.getElementById('exportarExcel').addEventListener('click', () => {
      const visitas = obtenerVisitas();
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;

      const visitasFiltradas = visitas.filter(v => {
        const fechaVisita = new Date(v.fecha);
        const desde = fechaInicio ? new Date(fechaInicio) : null;
        const hasta = fechaFin ? new Date(fechaFin) : null;

        if (desde && fechaVisita < desde) return false;
        if (hasta && fechaVisita > hasta) return false;
        return true;
      });

      if (visitasFiltradas.length === 0) {
        alert('No hay visitas en el rango seleccionado.');
        return;
      }

      const datosExcel = visitasFiltradas.map(v => ({
        Cliente: v.cliente,
        Taller: v.taller || '',
        Fecha: v.fecha,
        'Hora Llegada': v.horaLlegada,
        Comentarios: v.comentarios,
        'Hora Salida': v.horaSalida || '',
        'Fecha Seguimiento': v.fechaSeguimiento || ''
      }));

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(datosExcel);
      XLSX.utils.book_append_sheet(wb, ws, 'Visitas');

      XLSX.writeFile(wb, `visitas_${fechaInicio || 'inicio'}_a_${fechaFin || 'hoy'}.xlsx`);
    });
  </script>

</body>
</html>
